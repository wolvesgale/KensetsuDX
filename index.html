<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å‡ºé€€å‹¤ï¼ˆLIFFï¼‰</title>
  <script src="https://static.line-scdn.net/liff/edge/versions/2.22.4/sdk.js"></script>
  <style>
    :root{
      --blue:#004b8f;    /* ãƒ¡ã‚¤ãƒ³ */
      --yellow:#f5b400;  /* ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
      --danger:#d9534f;
      --bg:#f7f9fc;
      --ink:#1b1f23;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{
      width:min(560px,92vw);
      background:#fff;border-radius:20px;padding:24px 20px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    .title{display:flex;align-items:center;gap:10px;margin:0 0 8px}
    .title b{font-size:22px;color:var(--blue)}
    .sub{color:#657184;margin:0 0 18px}
    .who{color:#333;margin:2px 0 10px}
    .state{margin:8px 0 16px;font-weight:600}
    .btns{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;justify-items:center}
    button{
      width:100%;max-width:240px;height:56px;font-size:18px;
      border:none;border-radius:12px;cursor:pointer;transition:.15s transform;
    }
    .primary{background:var(--blue);color:#fff}
    .warn{background:var(--yellow);color:#111}
    .danger{background:var(--danger);color:#fff}
    .ghost{background:#eef3f8;color:#111}
    button:hover{transform:translateY(-1px)}
    button:disabled{opacity:.45;cursor:not-allowed;transform:none}
    .msg{margin-top:14px;min-height:1.4em;white-space:pre-wrap}
    .muted{opacity:.6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1 class="title">ğŸ› ï¸ <b>å‡ºé€€å‹¤</b></h1>
      <p class="sub">ã€Œé¢å€’ã€ã‚’ãƒ¯ãƒ³ã‚¯ãƒªãƒƒã‚¯ã«ã€‚LINEã§ãƒ©ã‚¯ã«æ‰“åˆ»ã€‚</p>

      <div id="who" class="who muted">ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªä¸­â€¦</div>
      <div id="state" class="state">çŠ¶æ…‹: <b>-</b></div>

      <div class="btns">
        <button id="btn-in"      class="primary">å‡ºå‹¤</button>
        <button id="btn-brk"     class="warn">ä¼‘æ†©é–‹å§‹</button>
        <button id="btn-brkend"  class="ghost">ä¼‘æ†©çµ‚äº†</button>
        <button id="btn-out"     class="danger">é€€å‹¤</button>
      </div>

      <div id="msg" class="msg"></div>
    </div>
  </div>

  <script>
    // ==== å¿…è¦ãªã®ã¯ã“ã“ã ã‘ï¼ˆã‚ãªãŸã® LIFF ID ã«å·®ã—æ›¿ãˆï¼‰ ====
    const LIFF_ID = '2008230823-ZwNqedOQ';
    // API ã¯ Vercel ã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹é–¢æ•°ï¼ˆç›¸å¯¾ãƒ‘ã‚¹ã§OKï¼‰
    const API_URL = '/api/punch';

    // ==== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====
    const $ = sel => document.querySelector(sel);
    const setState = s => $('#state').innerHTML = 'çŠ¶æ…‹: <b>' + s + '</b>';
    const say = t => $('#msg').textContent = String(t || '');
    const enable = (id, on) => { const el=$(id); if(!el) return; el.disabled=!on; el.classList.toggle('muted',!on); };
    const setAll = on => ['#btn-in','#btn-brk','#btn-brkend','#btn-out'].forEach(id=>enable(id,on));

    async function call(action, idToken){
      say('é€ä¿¡ä¸­â€¦'); setAll(false);
      try{
        const r = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ action, idToken })
        });
        const data = await r.json().catch(()=>({ ok:false, error:'Invalid JSON' }));
        say(data.message || data.error || '');
        if (data.status) setState(data.status);
        applyButtons(data.status || 'IDLE');
        return data;
      }catch(e){
        say('é€šä¿¡ã‚¨ãƒ©ãƒ¼: ' + (e?.message || e));
        applyButtons('IDLE');
        return { ok:false, error:String(e) };
      }
    }

    function applyButtons(status){
      setAll(false);
      if(status==='IDLE'){            // æœªå‡ºå‹¤
        enable('#btn-in', true);
      }else if(status==='WORKING'){   // å‹¤å‹™ä¸­
        enable('#btn-brk', true);
        enable('#btn-out', true);
      }else if(status==='BREAKING'){  // ä¼‘æ†©ä¸­
        enable('#btn-brkend', true);
        enable('#btn-out', true);
      }
    }

    (async () => {
      try{
        await liff.init({ liffId: LIFF_ID });

        if(!liff.isLoggedIn()){
          // PCãƒ–ãƒ©ã‚¦ã‚¶ç›´é–‹ãã§ã‚‚ LIFF ã¸æˆ»ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
          return liff.login({ redirectUri: `https://liff.line.me/${LIFF_ID}` });
        }

        const prof = await liff.getProfile();
        $('#who').textContent = `ã‚ˆã†ã“ãã€${prof.displayName} ã•ã‚“`;
        $('#who').classList.remove('muted');

        const idToken = liff.getIDToken();
        if(!idToken){ say('IDãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚'); return liff.logout(), location.reload(); }

        // åˆæœŸçŠ¶æ…‹
        const init = await call('noop', idToken);
        setState(init.status || 'IDLE');
        applyButtons(init.status || 'IDLE');

        // ãƒãƒ³ãƒ‰ãƒ©
        $('#btn-in').onclick      = async ()=>{ const r=await call('clock_in',    idToken); };
        $('#btn-brk').onclick     = async ()=>{ const r=await call('break_start', idToken); };
        $('#btn-brkend').onclick  = async ()=>{ const r=await call('break_end',   idToken); };
        $('#btn-out').onclick     = async ()=>{ const r=await call('clock_out',   idToken); };

      }catch(e){
        say('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + (e?.message || e));
        console.error(e);
      }
    })();
  </script>
</body>
</html>
